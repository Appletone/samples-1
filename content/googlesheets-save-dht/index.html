<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>使用 Google Sheet 儲存 DHT 數據</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="https://webduino.io/components/webduino-js/dist/webduino-all.min.js"></script>
  <script src="https://blockly.webduino.io/webduino-blockly.js"></script>
  <script src="https://blockly.webduino.io/lib/runtime.min.js"></script>
  <style>
  body{
  	line-height:40px;
  }
  	body, input, button, select, option{
  		font-size:20px;
  	}
  	button{
  		margin:10px 0;
  	}
  	select{
  		font-size:30px!important;
  	}
  </style>
</head>

<body>
  開發板 ID：
  <input id="deviceID">
  <br/> 溫濕度傳感器腳位：
  <select id="dhtPin">
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
    <option value="11">11</option>
    <option value="12">12</option>
    <option value="13">13</option>
  </select>
  <br/> 擷取時間：
  <select id="dhtTime">
    <option value="500">0.5 秒</option>
    <option value="750">0.75 秒</option>
    <option value="1000">1 秒</option>
    <option value="2000">2 秒</option>
    <option value="3000">3 秒</option>
    <option value="4000">4 秒</option>
    <option value="5000">5 秒</option>
    <option value="10000">10 秒</option>
    <option value="20000">20 秒</option>
    <option value="30000">30 秒</option>
    <option value="60000">60 秒</option>
  </select>
  <br/> 試算表網址：
  <input id="sheetUrl">
  <br/> 試算表名稱：
  <input id="sheetName" value="工作表1">
  <br/>
  <button id="submit">連線並開始儲存</button>
  <script>
  var deviceID = document.getElementById('deviceID');
  var dhtPin = document.getElementById('dhtPin');
  var dhtTime = document.getElementById('dhtTime');
  var sheetUrl = document.getElementById('sheetUrl');
  var sheetUrName = document.getElementById('sheetName');
  var submit = document.getElementById('submit');

  function writeSheetData(d) {
    $.get("https://script.google.com/macros/s/AKfycbyrYjDKcUswV_9VADdmHZ7WHnT5KmBp13k0-1NNCcDQ9w8H463m/exec", d);
  }

  function readSheetData(d, callback) {
    $.get("https://script.google.com/macros/s/AKfycbxJjv240G64yTmUyIzkCKi9r7Jux2c1YvEsaDWS-eawMjQz-nQ/exec", d, function(data) {
      callback(data);
    });
  }

  function get_time(t) {
    var varTime = new Date(),
      varHours = varTime.getHours(),
      varMinutes = varTime.getMinutes(),
      varSeconds = varTime.getSeconds();
    var varNow;
    if (t == "hms") {
      varNow = varHours + ":" + varMinutes + ":" + varSeconds;
    } else if (t == "h") {
      varNow = varHours;
    } else if (t == "m") {
      varNow = varMinutes;
    } else if (t == "s") {
      varNow = varSeconds;
    }
    return varNow;
  }

  var dht;
  var myData = {};

  if(window.localStorage.deviceID){
  	deviceID.value = window.localStorage.deviceID;
  }
  if(window.localStorage.dhtPin){
  	dhtPin.value = window.localStorage.dhtPin;
  }
  if(window.localStorage.dhtTime){
  	dhtTime.value = window.localStorage.dhtTime;
  }
  if(window.localStorage.sheetUrl){
  	sheetUrl.value = window.localStorage.sheetUrl;
  }
  if(window.localStorage.sheetName){
  	sheetName.value = window.localStorage.sheetName;
  }


  submit.onclick = function() {
  	window.localStorage.deviceID = deviceID.value;
  	window.localStorage.dhtPin = dhtPin.value;
  	window.localStorage.sheetUrl = sheetUrl.value;
  	window.localStorage.sheetName = sheetName.value;
    console.log('ready');
    console.log(dhtPin.value * 1);
    boardReady(deviceID.value, function(board) {
      console.log('board ready');
      board.systemReset();
      board.samplingInterval = 250;
      dht = getDht(board, dhtPin.value * 1);
      myData = {};
      myData.sheetUrl = sheetUrl.value;
      myData.sheetName = sheetName.value;
      console.log(myData);
      dht.read(function(evt) {
        console.log(dht.temperature);
        myData.column0 = get_time("hms");
        myData.column1 = dht.temperature;
        myData.column2 = dht.humidity;
        writeSheetData(myData);
      }, dhtTime.value * 1);
    });
  };
  </script>
</body>

</html>
