<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>google map dht</title>
  <script src="https://webduino.io/components/webduino-js/dist/webduino-all.min.js"></script>
  <script src="https://blockly.webduino.io/webduino-blockly.js"></script>
  <script src="https://blockly.webduino.io/lib/runtime.min.js"></script>
  <style>
  html,
  body {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  
  #setup {
    box-sizing: content-box;
    height: 110px;
    line-height: 30px;
    font-size: 16px;
    padding: 5px 20px 0;
  }
  
  #setup input,
  #setup select {
    margin: 0 10px 0 0;
  }
  
  #setup button {
    font-size: 16px;
    margin: 10px 0 0;
  }
  
  #mapAddress {
    width: 400px;
  }
  
  #map {
    width: 100%;
    height: calc(100% - 120px);
  }
  
  .mapMarker {
    line-height: 20px;
  }
  
  .mapMarker h3 {
    margin: 5px 0 8px 0;
    padding: 5px 0 8px 0;
    border-bottom: 1px solid #ccc;
  }
  </style>
</head>

<body>
  <div id="setup">
    開發板 ID：
    <input id="deviceID"> 溫濕度腳位：
    <select id="dhtPin">
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
      <option value="13">13</option>
    </select>
    擷取時間：
    <select id="dhtTime">
      <option value="500">0.5 秒</option>
      <option value="750">0.75 秒</option>
      <option value="1000">1 秒</option>
      <option value="2000">2 秒</option>
      <option value="3000">3 秒</option>
      <option value="4000">4 秒</option>
      <option value="5000">5 秒</option>
      <option value="10000">10 秒</option>
      <option value="20000">20 秒</option>
      <option value="30000">30 秒</option>
      <option value="60000">60 秒</option>
    </select> 
    <br/>
    目的地名稱：
    <input id="mapAddressName">
    地址：
    <input id="mapAddress">
    <br/>
    <button id="submit">連線並開始偵測</button>
    <button id="refresh" disabled='true'>重新偵測</button>
  </div>
  <div id="map"></div>
  <script type="text/javascript">
  var deviceID = document.getElementById('deviceID');
  var dhtPin = document.getElementById('dhtPin');
  var dhtTime = document.getElementById('dhtTime');
  var mapAddress = document.getElementById('mapAddress');
  var mapAddressName = document.getElementById('mapAddressName');
  var submit = document.getElementById('submit');
  var refresh = document.getElementById('refresh');

  if (window.localStorage.deviceID) {
    deviceID.value = window.localStorage.deviceID;
  }
  if (window.localStorage.dhtPin) {
    dhtPin.value = window.localStorage.dhtPin;
  }
  if (window.localStorage.dhtTime) {
    dhtTime.value = window.localStorage.dhtTime;
  }
  if (window.localStorage.mapAddress) {
    mapAddress.value = window.localStorage.mapAddress;
  }
  if (window.localStorage.mapAddressName) {
    mapAddressName.value = window.localStorage.mapAddressName;
  }


  var gmapKey = 'AIzaSyB6TBwRrd2pQeyD0COblf4uADkO1EMjSCw';
  var gmapCenter = '高雄市前鎮區復興四路20號';
  var gmapZoom = 16;
  var gmapZIndex = 1;
  var gmap;
  var gmapPosArray = [];
  var gmapMarkerArray = [];

  function loadScript(url, callback) {

    var script = document.createElement('script')
    script.type = 'text/javascript';

    script.onload = function() {
      callback();
    };

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  loadScript('https://maps.googleapis.com/maps/api/js?key=' + gmapKey, gmapFn);

  function gmapFn() {

    initialize();

    function initialize() {
      gmap = new google.maps.Map(document.getElementById('map'), {
        zoom: gmapZoom
      });
      setCenter(gmapCenter);
    }

    function setCenter(address) {
      var marker = new google.maps.Marker({
        map: gmap
      });
      geocoder = new google.maps.Geocoder();
      geocoder.geocode({
        address: address
      }, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          LatLng = results[0].geometry.location;
          gmap.setCenter(LatLng);
        } else {
          gmap.setCenter({
            lat: 22.604,
            lng: 120.299
          });
        }
      });
    }

    function addressMarker(address, title, markerID, callback, icon) {
      if (gmapPosArray.indexOf(markerID) == -1) {

        gmapPosArray.push(markerID);

        gmapZIndex = gmapZIndex + 1;

        if (icon) {
          var marker = new google.maps.Marker({
            map: gmap,
            zIndex: gmapZIndex,
            icon: icon
          });
        } else {
          var marker = new google.maps.Marker({
            map: gmap,
            zIndex: gmapZIndex
          });
        }

        gmapMarkerArray.push(marker);

        geocoder = new google.maps.Geocoder();
        geocoder.geocode({
          address: address
        }, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            LatLng = results[0].geometry.location;
            marker.setPosition(LatLng);
            console.log('lat:' + LatLng.lat() + ',lng:' + LatLng.lng());

            var infowindow = new google.maps.InfoWindow({
              content: '<div id="' + markerID + '" class="mapMarker" style="z-index:' + gmapZIndex + ';"><h3>' + title + '</h3><div class="markerContent"></div></div>'
            });

            infowindow.open(gmap, marker);
            marker.addListener('click', function() {
              infowindow.open(gmap, marker);
            });

            google.maps.event.addListener(infowindow, 'domready', function() {
              if (callback) {
                callback();
              };
            });

          } else {
            console.log(address + ' is error');
          }
        });
      }
    }



    submit.onclick = function() {
      submit.disabled = true;
      refresh.disabled = false;
      window.localStorage.deviceID = deviceID.value;
      window.localStorage.dhtPin = dhtPin.value;
      window.localStorage.mapAddressName = mapAddressName.value;
      window.localStorage.mapAddress = mapAddress.value;
      window.localStorage.dhtTime = dhtTime.value;
      addressMarker(mapAddress.value, mapAddressName.value, 'a1', test);
    };

    refresh.onclick = function(){
      location.reload();
    };



    function test() {
      console.log('ready');
      boardReady(deviceID.value, function(board) {
        console.log('board ready');
        board.systemReset();
        board.samplingInterval = 250;
        dht = getDht(board, dhtPin.value * 1);
        dht.read(function(evt) {
          document.querySelector('#a1 .markerContent').innerHTML = '溫度：' + dht.temperature + '度<br/>濕度：'+dht.humidity+'%';
        }, dhtTime.value * 1);
      });
    }

  }
  </script>
</body>

</html>
